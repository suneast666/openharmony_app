import { router } from '@kit.ArkUI';

// æ—¥è®°æ•°æ®æ¨¡å‹
class DiaryEntry {
  id: string = '';
  title: string = '';
  content: string = '';
  date: string = '';
  time: string = '';
  mood: string = 'neutral';
  tags: string[] = [];

  constructor(
    title: string = '',
    content: string = '',
    mood: string = 'neutral',
    tags: string[] = []
  ) {
    this.id = this.generateId();
    this.title = title;
    this.content = content;
    const now: Date = new Date();
    this.date = now.toISOString().split('T')[0];
    this.time = now.toTimeString().split(' ')[0].substring(0, 5);
    this.mood = mood;
    this.tags = tags;
  }

  private generateId(): string {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
  }
}

// ä½¿ç”¨ AppStorage è¿›è¡Œæ•°æ®å­˜å‚¨
@Entry
@Component
struct Index {
  // ä½¿ç”¨ AppStorage å­˜å‚¨æ—¥è®°æ•°æ®
  @StorageLink('diaries') diaries: DiaryEntry[] = [];
  @StorageLink('searchText') searchText: string = '';
  @State showSearch: boolean = false;

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆå§‹åŒ–æ•°æ®
  aboutToAppear() {
    // åˆå§‹åŒ–ä¸€äº›ç¤ºä¾‹æ•°æ®ï¼Œå¦‚æœAppStorageä¸­æ²¡æœ‰æ•°æ®
    if (AppStorage.get<DiaryEntry[]>('diaries') === undefined) {
      const sampleDiaries: DiaryEntry[] = [
        new DiaryEntry('ç¾å¥½çš„ä¸€å¤©', 'ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œå¿ƒæƒ…ä¹Ÿä¸é”™ï¼', 'happy', ['å¼€å¿ƒ', 'å¤©æ°”']),
        new DiaryEntry('å­¦ä¹ ç¬”è®°', 'ä»Šå¤©å­¦ä¹ äº†ArkTSçš„ç”¨æ³•ï¼Œæ”¶è·å¾ˆå¤š', 'neutral', ['å­¦ä¹ ', 'æŠ€æœ¯']),
        new DiaryEntry('ç¾é£Ÿæ—¥è®°', 'å°è¯•äº†ä¸€å®¶æ–°é¤å…ï¼Œå‘³é“å¾ˆæ£’ï¼', 'excited', ['ç¾é£Ÿ', 'æ¢åº—'])
      ];
      AppStorage.setOrCreate<DiaryEntry[]>('diaries', sampleDiaries);
    }
  }

  // æœç´¢æ—¥è®°
  getFilteredDiaries(): DiaryEntry[] {
    if (!this.searchText.trim()) {
      return this.diaries;
    }

    const lowerKeyword: string = this.searchText.toLowerCase();
    return this.diaries.filter((diary: DiaryEntry) => {
      return diary.title.toLowerCase().includes(lowerKeyword) ||
      diary.content.toLowerCase().includes(lowerKeyword) ||
      diary.tags.some((tag: string) => tag.toLowerCase().includes(lowerKeyword));
    });
  }

  // åˆ é™¤æ—¥è®°
  deleteDiary(id: string) {
    const newDiaries: DiaryEntry[] = this.diaries.filter((diary: DiaryEntry) => diary.id !== id);
    AppStorage.setOrCreate<DiaryEntry[]>('diaries', newDiaries);
  }

  // æ¸²æŸ“å¿ƒæƒ…å›¾æ ‡
  @Builder
  moodIcon(mood: string) {
    if (mood === 'happy') {
      Text('ğŸ˜Š')
        .fontSize(24)
        .width(30)
        .height(30)
        .textAlign(TextAlign.Center);
    } else if (mood === 'sad') {
      Text('ğŸ˜¢')
        .fontSize(24)
        .width(30)
        .height(30)
        .textAlign(TextAlign.Center);
    } else if (mood === 'excited') {
      Text('ğŸ˜ƒ')
        .fontSize(24)
        .width(30)
        .height(30)
        .textAlign(TextAlign.Center);
    } else if (mood === 'angry') {
      Text('ğŸ˜ ')
        .fontSize(24)
        .width(30)
        .height(30)
        .textAlign(TextAlign.Center);
    } else {
      Text('ğŸ˜')
        .fontSize(24)
        .width(30)
        .height(30)
        .textAlign(TextAlign.Center);
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('æˆ‘çš„æ—¥è®°æœ¬')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 16 })
          .fontColor('#000000')

        Blank()

        // æœç´¢æŒ‰é’®
        Button(this.showSearch ? 'å–æ¶ˆ' : 'æœç´¢')
          .margin({ right: 16 })
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            this.showSearch = !this.showSearch;
            if (!this.showSearch) {
              this.searchText = '';
            }
          })

        // æ·»åŠ æŒ‰é’®
        Button('+')
          .margin({ right: 16 })
          .fontSize(20)
          .width(40)
          .height(40)
          .borderRadius(20)
          .backgroundColor('#007DFF')
          .fontColor(Color.White)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/DiaryEdit',
              params: { mode: 'add' }
            });
          })
      }
      .width('100%')
      .height(60)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 4, color: '#DDDDDD' })

      // æœç´¢æ 
      if (this.showSearch) {
        TextInput({ placeholder: 'æœç´¢æ—¥è®°æ ‡é¢˜æˆ–å†…å®¹...', text: this.searchText })
          .width('90%')
          .height(40)
          .margin({ top: 10, bottom: 10 })
          .backgroundColor(Color.White)
          .border({ width: 1, color: '#DDDDDD' })
          .borderRadius(8)
          .padding({ left: 10, right: 10 })
          .onChange((value: string) => {
            this.searchText = value;
          })
      }

      // æ—¥è®°åˆ—è¡¨ - ä½¿ç”¨è®¡ç®—å±æ€§è€Œä¸æ˜¯æœ¬åœ°å˜é‡
      // è·å–è¿‡æ»¤åçš„æ—¥è®°åˆ—è¡¨
      if (this.getFilteredDiaries().length > 0) {
        List({ space: 10 }) {
          ForEach(this.getFilteredDiaries(), (diary: DiaryEntry) => {
            ListItem() {
              Row() {
                // å¿ƒæƒ…å›¾æ ‡
                Column() {
                  this.moodIcon(diary.mood)
                  Text(diary.time)
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 4 })
                }
                .margin({ right: 15 })
                .alignItems(HorizontalAlign.Center)

                // æ—¥è®°å†…å®¹æ‘˜è¦
                Column({ space: 4 }) {
                  Row() {
                    Text(diary.title || 'æ— æ ‡é¢˜')
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })

                    Blank()

                    // æ ‡ç­¾
                    if (diary.tags.length > 0) {
                      Row({ space: 4 }) {
                        ForEach(diary.tags.slice(0, 2), (tag: string) => {
                          Text(tag)
                            .fontSize(10)
                            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                            .backgroundColor('#E8F4FD')
                            .borderRadius(10)
                            .fontColor('#007DFF')
                        })
                      }
                    }
                  }
                  .width('100%')

                  Text(diary.content.length > 100 ?
                    diary.content.substring(0, 100) + '...' : diary.content)
                    .fontSize(14)
                    .fontColor('#666666')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(diary.date)
                    .fontSize(12)
                    .fontColor('#999999')
                    .margin({ top: 4 })
                }
                .layoutWeight(1)
              }
              .padding(15)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .shadow({ radius: 3, color: '#EEEEEE' })
            }
            .onClick(() => {
              router.pushUrl({
                url: 'pages/DiaryEdit',
                params: {
                  mode: 'edit',
                  diaryId: diary.id
                }
              });
            })
          })
        }
        .layoutWeight(1)
        .margin({ top: 10 })
        .width('100%')
        .height('100%')
      } else {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“')
            .fontSize(60)
            .margin({ bottom: 20 })

          Text(this.searchText ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥è®°' : 'è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå¼€å§‹è®°å½•å§ï¼')
            .fontSize(16)
            .fontColor('#666666')

          if (!this.searchText) {
            Button('å†™ç¬¬ä¸€ç¯‡æ—¥è®°')
              .margin({ top: 20 })
              .backgroundColor('#007DFF')
              .fontColor(Color.White)
              .onClick(() => {
                router.pushUrl({
                  url: 'pages/DiaryEdit',
                  params: { mode: 'add' }
                });
              })
          }
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}